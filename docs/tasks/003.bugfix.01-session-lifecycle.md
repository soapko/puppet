# 003.bugfix.01: Session Lifecycle and Error Recovery

**Status:** Complete
**Priority:** High

## Objective

Fix session lifecycle issues that cause subsequent tests to fail when the browser window is closed unexpectedly.

## Problem

When the browser window gets closed (either by test code, user interaction, or crash), all subsequent commands fail because:

1. The session doesn't detect browser disconnection
2. Commands continue using stale `page`/`browser` references
3. `isRunning()` returns true even when browser is dead
4. No way to recover or restart the session

## Technical Details

### Current Behavior

1. Browser closes unexpectedly
2. Session's `running` flag stays `true`
3. Next command tries to use dead `page` reference
4. Command fails with cryptic error (e.g., "Target closed")
5. All subsequent commands fail the same way
6. Test suite appears broken

### Root Causes

**Location:** `src/session.ts`

1. **No disconnect listeners** (lines 45-64)
   - Missing `browser.on('disconnected', ...)` handler
   - Missing `page.on('close', ...)` handler

2. **No error classification** (lines 153-161)
   - All errors treated the same
   - "Target closed" not distinguished from "element not found"

3. **Stale `isRunning()` check** (lines 240-242)
   - Only checks boolean flag, not actual browser state

4. **No recovery mechanism**
   - Session cannot restart after browser death

## Implementation Plan

### Step 1: Add Browser/Page Event Listeners

After browser launch (around line 49), add:

```typescript
// Track browser state
let browserConnected = true;

browser.on('disconnected', () => {
  log.error('Browser disconnected');
  browserConnected = false;
  running = false;
});

page.on('close', () => {
  log.error('Page closed');
  running = false;
});
```

### Step 2: Add Health Check Before Commands

In `processCommand()`, add early return if browser is dead:

```typescript
async function processCommand(cmd: Command): Promise<CommandResult> {
  if (!browserConnected) {
    return {
      id: cmd.id,
      success: false,
      error: 'Browser disconnected. Session needs restart.',
    };
  }
  // ... rest of command processing
}
```

### Step 3: Improve Error Detection

Add helper to detect fatal errors:

```typescript
function isBrowserDeadError(err: unknown): boolean {
  if (!(err instanceof Error)) return false;
  const msg = err.message.toLowerCase();
  return (
    msg.includes('target closed') ||
    msg.includes('browser has been closed') ||
    msg.includes('context has been closed') ||
    msg.includes('page has been closed')
  );
}
```

Update error handling in `processCommand()` catch block:

```typescript
catch (err) {
  if (isBrowserDeadError(err)) {
    browserConnected = false;
    running = false;
  }
  // ... rest of error handling
}
```

### Step 4: Update `isRunning()` Method

```typescript
isRunning() {
  return running && browserConnected;
}
```

### Step 5: Add `restart()` Method to Session Interface

Update `src/types.ts`:

```typescript
export interface Session {
  close(): Promise<void>;
  getUrl(): string;
  isRunning(): boolean;
  restart(): Promise<void>; // NEW
  isBrowserConnected(): boolean; // NEW
}
```

Implement in `session.ts`:

```typescript
return {
  async close() {
    /* existing */
  },
  getUrl() {
    /* existing */
  },
  isRunning() {
    return running && browserConnected;
  },

  isBrowserConnected() {
    return browserConnected;
  },

  async restart() {
    log.info('Restarting session...');
    await cleanup();

    // Re-launch browser
    const { browser: newBrowser, page: newPage } = await getBrowser({
      headless: options.headless ?? false,
      viewport: options.viewport,
    });

    browser = newBrowser;
    page = newPage;
    cursor = createCursor(page);
    browserConnected = true;
    running = true;

    // Re-attach event listeners
    // ... (same as initial setup)

    log.info('Session restarted');
  },
};
```

## Acceptance Criteria

- [x] Browser disconnect is detected and logged
- [x] Page close is detected and logged
- [x] `isRunning()` returns false when browser is dead
- [x] Commands return clear error message when browser is dead
- [x] `isBrowserConnected()` method works correctly
- [x] `restart()` method restores session to working state
- [x] Tests can call `restart()` to recover from browser death

## Testing

### Manual Testing

1. Start a session
2. Close browser window manually
3. Verify `isRunning()` returns false
4. Call `restart()`
5. Verify session works again

### Automated Testing

```javascript
import { startSession, sendCommand } from 'puppet';

const session = await startSession();

// Force close browser
await sendCommand({ action: 'evaluate', params: { script: 'window.close()' } });

// Should detect browser is dead
console.log(session.isRunning()); // false
console.log(session.isBrowserConnected()); // false

// Should recover
await session.restart();
console.log(session.isRunning()); // true

await sendCommand({ action: 'goto', params: { url: 'https://example.com' } });
// Should work
```

## Notes

- The `restart()` method needs to handle variable reassignment carefully since `browser`, `page`, and `cursor` are declared with `const` in the current implementation
- May need to refactor to use `let` or store in an object
