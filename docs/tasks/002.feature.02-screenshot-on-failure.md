# 002.feature.02: Screenshot on Failure

**Status:** Pending
**Priority:** High
**Complexity:** Low

## Objective

Automatically capture a screenshot when any command fails, providing immediate visual debugging context.

## Context

When automated tests fail, the most useful debugging artifact is seeing what the page looked like at the moment of failure. Currently, failures only return error messages which often don't convey why an element wasn't found or why an action failed.

## Technical Details

### Implementation Location

`src/session.ts` - in the `processCommand` function's catch block

### Approach

1. On command failure, capture a full-page screenshot
2. Save to `~/.puppet/failures/error-<timestamp>.png`
3. Include the screenshot path in the error result
4. Skip screenshot capture if:
   - Browser is disconnected
   - The failed command was itself a screenshot command

### Code Changes

```typescript
// In processCommand catch block
} catch (err) {
  const errorMsg = err instanceof Error ? err.message : String(err);
  log.error(`Command ${action} failed:`, errorMsg);

  // Capture screenshot on failure
  let screenshotPath: string | undefined;
  if (browserConnected && action !== 'screenshot') {
    try {
      const timestamp = Date.now();
      screenshotPath = `${homedir()}/.puppet/failures/error-${timestamp}.png`;
      await mkdir(dirname(screenshotPath), { recursive: true });
      await page.screenshot({ path: screenshotPath, fullPage: true });
      log.info(`Failure screenshot saved: ${screenshotPath}`);
    } catch (screenshotErr) {
      log.debug('Failed to capture failure screenshot:', screenshotErr);
    }
  }

  return {
    id,
    success: false,
    error: errorMsg,
    screenshotPath,  // New field in CommandResult
  };
}
```

### Type Changes

Update `CommandResult` in `src/types.ts`:

```typescript
interface CommandResult {
  id: string;
  success: boolean;
  result?: unknown;
  error?: string;
  screenshotPath?: string; // New field
}
```

## Acceptance Criteria

- [ ] Failed commands capture a screenshot automatically
- [ ] Screenshot saved to `~/.puppet/failures/` with timestamp
- [ ] Screenshot path included in command result
- [ ] No screenshot attempted if browser is disconnected
- [ ] No screenshot attempted if screenshot command itself fails
- [ ] Directory created automatically if it doesn't exist

## Testing

```javascript
// Force a failure and verify screenshot is captured
await sendCommand({ action: 'click', params: { selector: '.nonexistent-element' } });
// Check ~/.puppet/failures/ for new screenshot
// Verify result includes screenshotPath field
```
