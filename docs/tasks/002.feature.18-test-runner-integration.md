# 002.feature.18: Test Runner Integration

**Status:** Pending
**Priority:** Low
**Complexity:** High

## Objective

Create first-class integration with popular test runners (Jest, Vitest, Mocha) for seamless browser testing.

## Context

Currently, using puppet in tests requires manual setup:

```typescript
import { startSession, sendCommand } from 'puppet';

describe('Login', () => {
  beforeAll(async () => {
    await startSession({ headless: true });
  });

  afterAll(async () => {
    await sendCommand({ action: 'close' });
  });

  it('should login', async () => {
    await sendCommand({ action: 'goto', params: { url: '...' } });
    // ... manual assertions
  });
});
```

With integration:

```typescript
import { test, expect } from 'puppet/test';

test('user can login', async ({ page }) => {
  await page.goto('/login');
  await page.fill('email', 'user@test.com');
  await page.click('submit');
  await expect(page).toHaveURL('/dashboard');
});
```

## Technical Details

### New Package Entry: puppet/test

```typescript
// src/test/index.ts
export { test, expect } from './runner.js';
export { defineConfig } from './config.js';
```

### Test Runner Wrapper

```typescript
// src/test/runner.ts
import { test as baseTest } from 'vitest'; // or detect runner
import { puppet, withBrowser, Browser } from '../fluent.js';

interface TestFixtures {
  page: Browser;
}

export const test = baseTest.extend<TestFixtures>({
  page: async ({}, use) => {
    await withBrowser(
      async browser => {
        await use(browser);
      },
      { headless: true }
    );
  },
});

export { expect } from 'vitest';
```

### Custom Matchers

```typescript
// src/test/matchers.ts
import { expect } from 'vitest';
import type { Browser } from '../fluent.js';

expect.extend({
  async toHaveURL(browser: Browser, expected: string) {
    const actual = await browser.url();
    const pass = expected.startsWith('/')
      ? actual.endsWith(expected) || actual.includes(expected)
      : actual === expected;

    return {
      pass,
      message: () => `Expected URL ${pass ? 'not ' : ''}to be "${expected}", got "${actual}"`,
    };
  },

  async toHaveText(browser: Browser, selector: string, expected: string) {
    const actual = await browser.text(selector);
    const pass = actual.includes(expected);

    return {
      pass,
      message: () =>
        `Expected "${selector}" ${pass ? 'not ' : ''}to have text "${expected}", got "${actual}"`,
    };
  },

  async toBeVisible(browser: Browser, selector: string) {
    try {
      await browser.assertVisible(selector);
      return { pass: true, message: () => `Expected "${selector}" not to be visible` };
    } catch {
      return { pass: false, message: () => `Expected "${selector}" to be visible` };
    }
  },
});
```

### Configuration

```typescript
// src/test/config.ts
export interface PuppetConfig {
  baseURL?: string;
  headless?: boolean;
  slowMo?: number;
  timeout?: number;
  screenshotOnFailure?: boolean;
  video?: boolean;
}

let config: PuppetConfig = {
  headless: true,
  timeout: 30000,
  screenshotOnFailure: true,
};

export function defineConfig(userConfig: PuppetConfig): PuppetConfig {
  config = { ...config, ...userConfig };
  return config;
}

export function getConfig(): PuppetConfig {
  return config;
}
```

### Project Config File

```typescript
// puppet.config.ts (user creates this)
import { defineConfig } from 'puppet/test';

export default defineConfig({
  baseURL: 'http://localhost:3000',
  headless: true,
  timeout: 30000,
  screenshotOnFailure: true,
});
```

## Usage Examples

### Basic Test

```typescript
// tests/login.test.ts
import { test, expect } from 'puppet/test';

test('user can login', async ({ page }) => {
  await page.goto('/login');
  await page.type('email', 'user@example.com');
  await page.type('password', 'secret123');
  await page.click('submit');

  await expect(page).toHaveURL('/dashboard');
  await expect(page).toHaveText('welcome', 'Hello, User');
});
```

### With Setup/Teardown

```typescript
import { test, expect } from 'puppet/test';

test.describe('Authenticated User', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login');
    await page.type('email', 'user@test.com');
    await page.type('password', 'password');
    await page.click('submit');
    await page.waitForLoaded();
  });

  test('can view dashboard', async ({ page }) => {
    await expect(page).toHaveURL('/dashboard');
  });

  test('can update profile', async ({ page }) => {
    await page.click('profile-link');
    await page.type('name', 'New Name');
    await page.click('save');
    await expect(page).toHaveText('success', 'Profile updated');
  });
});
```

### Running Tests

```bash
# With Vitest
npx vitest run tests/

# With Jest
npx jest tests/
```

## Acceptance Criteria

- [ ] `puppet/test` export works
- [ ] `test` function provides `page` fixture
- [ ] Browser auto-closes after each test
- [ ] Custom matchers: toHaveURL, toHaveText, toBeVisible
- [ ] Config file support (puppet.config.ts)
- [ ] baseURL support for relative URLs
- [ ] Screenshot on failure integrated
- [ ] Works with Vitest
- [ ] Works with Jest
- [ ] Documentation with examples

## Dependencies

Requires:

- 002.feature.11 (Fluent API)
- 002.feature.12 (Auto-managed sessions)
- 002.feature.13 (Built-in assertions)

## Testing

Create example test suite and run with both Vitest and Jest.

## Documentation Update

Create new guide: "Testing with Puppet" in how-to-use-puppet.md.
