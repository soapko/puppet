# 002.feature.13: Built-in Assertions

**Status:** Completed
**Priority:** Medium
**Complexity:** Medium

## Objective

Add assertion commands that verify page state and throw clear errors on failure.

## Context

Currently, testing requires manual checks:

```typescript
const text = await sendCommand({ action: 'getText', params: { selector: '#message' } });
if (text.result !== 'Success') {
  throw new Error(`Expected "Success" but got "${text.result}"`);
}
```

Built-in assertions are cleaner:

```typescript
await browser.assertText('message', 'Success');
// or
await browser.assertVisible('success-banner');
```

## Technical Details

### New Commands

| Command           | Params                           | Description                             |
| ----------------- | -------------------------------- | --------------------------------------- |
| `assertVisible`   | `selector`                       | Assert element is visible               |
| `assertHidden`    | `selector`                       | Assert element is hidden or not present |
| `assertText`      | `selector`, `expected`, `exact?` | Assert text content matches             |
| `assertValue`     | `selector`, `expected`           | Assert input value matches              |
| `assertChecked`   | `selector`                       | Assert checkbox/radio is checked        |
| `assertUnchecked` | `selector`                       | Assert checkbox/radio is not checked    |
| `assertEnabled`   | `selector`                       | Assert element is enabled               |
| `assertDisabled`  | `selector`                       | Assert element is disabled              |
| `assertUrl`       | `expected`, `exact?`             | Assert current URL matches              |
| `assertTitle`     | `expected`, `exact?`             | Assert page title matches               |
| `assertCount`     | `selector`, `count`              | Assert number of matching elements      |

### Implementation in session.ts

```typescript
case 'assertVisible': {
  const selector = resolveSelector(params.selector as string);
  const element = await page.$(selector);
  if (!element) {
    throw new Error(`Assertion failed: Element not found: ${selector}`);
  }
  const isVisible = await element.isVisible();
  if (!isVisible) {
    throw new Error(`Assertion failed: Element is not visible: ${selector}`);
  }
  result = { passed: true };
  break;
}

case 'assertText': {
  const selector = resolveSelector(params.selector as string);
  const expected = params.expected as string;
  const exact = params.exact !== false; // default true

  const element = await page.$(selector);
  if (!element) {
    throw new Error(`Assertion failed: Element not found: ${selector}`);
  }

  const actual = await element.textContent() || '';
  const matches = exact
    ? actual.trim() === expected
    : actual.includes(expected);

  if (!matches) {
    throw new Error(
      `Assertion failed: Text mismatch\n` +
      `  Selector: ${selector}\n` +
      `  Expected: "${expected}"\n` +
      `  Actual: "${actual.trim()}"\n` +
      `  Mode: ${exact ? 'exact' : 'contains'}`
    );
  }
  result = { passed: true, actual: actual.trim() };
  break;
}

case 'assertUrl': {
  const expected = params.expected as string;
  const exact = params.exact !== false;
  const actual = page.url();

  const matches = exact
    ? actual === expected
    : actual.includes(expected);

  if (!matches) {
    throw new Error(
      `Assertion failed: URL mismatch\n` +
      `  Expected: "${expected}"\n` +
      `  Actual: "${actual}"\n` +
      `  Mode: ${exact ? 'exact' : 'contains'}`
    );
  }
  result = { passed: true, actual };
  break;
}

case 'assertCount': {
  const selector = resolveSelector(params.selector as string);
  const expected = params.count as number;
  const elements = await page.$$(selector);
  const actual = elements.length;

  if (actual !== expected) {
    throw new Error(
      `Assertion failed: Element count mismatch\n` +
      `  Selector: ${selector}\n` +
      `  Expected: ${expected}\n` +
      `  Actual: ${actual}`
    );
  }
  result = { passed: true, count: actual };
  break;
}
```

### Fluent API Methods

```typescript
// In Browser class
async assertVisible(selector: string): Promise<void> {
  await sendCommand({
    action: 'assertVisible',
    params: { selector: this.resolveSelector(selector) }
  });
}

async assertText(selector: string, expected: string, exact = true): Promise<void> {
  await sendCommand({
    action: 'assertText',
    params: {
      selector: this.resolveSelector(selector),
      expected,
      exact
    }
  });
}

async assertUrl(expected: string, exact = true): Promise<void> {
  await sendCommand({
    action: 'assertUrl',
    params: { expected, exact }
  });
}
```

### Update types.ts

```typescript
type CommandAction =
  | 'assertVisible'
  | 'assertHidden'
  | 'assertText'
  | 'assertValue'
  | 'assertChecked'
  | 'assertUnchecked'
  | 'assertEnabled'
  | 'assertDisabled'
  | 'assertUrl'
  | 'assertTitle'
  | 'assertCount';
// ... existing actions
```

## Acceptance Criteria

- [ ] All assertion commands implemented
- [ ] Clear, multi-line error messages on failure
- [ ] `exact` parameter for partial matching (text, URL, title)
- [ ] Fluent API methods added
- [ ] TypeScript types updated
- [ ] Documentation with examples

## Testing

```typescript
import { withBrowser } from 'puppet';

await withBrowser(async browser => {
  await browser.goto('https://example.com');

  // These should pass
  await browser.assertVisible('main-heading');
  await browser.assertText('main-heading', 'Example Domain');
  await browser.assertUrl('example.com', false); // contains
  await browser.assertTitle('Example Domain');

  // These should fail with clear errors
  await browser.assertVisible('nonexistent'); // Element not found
  await browser.assertText('main-heading', 'Wrong Text'); // Text mismatch
  await browser.assertUrl('https://other.com'); // URL mismatch
});
```

## Documentation Update

Add to how-to-use-puppet.md:

```markdown
### Assertions

Built-in assertions verify page state and throw clear errors on failure:

// Element visibility
await browser.assertVisible('login-form');
await browser.assertHidden('loading-spinner');

// Text content
await browser.assertText('welcome', 'Hello, User');
await browser.assertText('welcome', 'Hello', false); // contains

// Form state
await browser.assertValue('email-input', 'test@example.com');
await browser.assertChecked('remember-me');
await browser.assertDisabled('submit-btn');

// Page state
await browser.assertUrl('/dashboard');
await browser.assertUrl('https://example.com/dashboard', true); // exact
await browser.assertTitle('Dashboard');

// Count elements
await browser.assertCount('list-item', 5);
```
