# 002.feature.17: REPL Mode

**Status:** Pending
**Priority:** Low
**Complexity:** Medium

## Objective

Add an interactive REPL (Read-Eval-Print Loop) for exploring and debugging browser automation interactively.

## Context

When developing automation scripts, it's helpful to:

- Explore a page interactively
- Test selectors before committing to code
- Debug issues in real-time
- Learn the API hands-on

A REPL provides immediate feedback and discovery.

## Technical Details

### New File: src/repl.ts

```typescript
import readline from 'readline';
import { startSession, sendCommand } from './session.js';
import { resolveSelector } from './selectors.js';
import type { SessionOptions } from './types.js';

export async function startRepl(options: SessionOptions = {}): Promise<void> {
  console.log('Starting Puppet REPL...');
  await startSession({ ...options, headless: false });
  console.log('Browser ready. Type commands or "help" for usage.\n');

  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
    prompt: 'puppet> ',
  });

  rl.prompt();

  rl.on('line', async line => {
    const trimmed = line.trim();
    if (!trimmed) {
      rl.prompt();
      return;
    }

    try {
      const result = await executeReplCommand(trimmed);
      if (result !== undefined) {
        console.log(result);
      }
    } catch (error) {
      console.error('Error:', error instanceof Error ? error.message : error);
    }

    rl.prompt();
  });

  rl.on('close', async () => {
    console.log('\nClosing browser...');
    await sendCommand({ action: 'close' });
    process.exit(0);
  });
}

async function executeReplCommand(input: string): Promise<unknown> {
  // Parse command
  const parts = input.match(/^(\w+)(?:\s+(.*))?$/);
  if (!parts) {
    throw new Error('Invalid command format');
  }

  const [, command, argsStr] = parts;
  const args = argsStr ? parseArgs(argsStr) : [];

  switch (command.toLowerCase()) {
    case 'help':
      return printHelp();

    case 'goto':
    case 'go':
      await sendCommand({ action: 'goto', params: { url: args[0] } });
      return `Navigated to ${args[0]}`;

    case 'click':
      await sendCommand({ action: 'click', params: { selector: resolveSelector(args[0]) } });
      return `Clicked ${args[0]}`;

    case 'type':
      await sendCommand({
        action: 'type',
        params: { selector: resolveSelector(args[0]), text: args.slice(1).join(' ') },
      });
      return `Typed into ${args[0]}`;

    case 'text':
      const textResult = await sendCommand({
        action: 'getText',
        params: { selector: resolveSelector(args[0]) },
      });
      return textResult.result;

    case 'html':
      const htmlResult = await sendCommand({
        action: 'getHtml',
        params: args[0] ? { selector: resolveSelector(args[0]) } : {},
      });
      return htmlResult.result;

    case 'screenshot':
    case 'ss':
      const ssResult = await sendCommand({
        action: 'screenshot',
        params: args[0] ? { path: args[0] } : {},
      });
      return `Screenshot saved: ${ssResult.result}`;

    case 'url':
      const urlResult = await sendCommand({
        action: 'evaluate',
        params: { script: 'window.location.href' },
      });
      return urlResult.result;

    case 'title':
      const titleResult = await sendCommand({
        action: 'evaluate',
        params: { script: 'document.title' },
      });
      return titleResult.result;

    case 'eval':
      const evalResult = await sendCommand({
        action: 'evaluate',
        params: { script: args.join(' ') },
      });
      return evalResult.result;

    case 'wait':
      await sendCommand({ action: 'wait', params: { ms: parseInt(args[0]) || 1000 } });
      return `Waited ${args[0] || 1000}ms`;

    case 'waitfor':
      await sendCommand({
        action: 'waitForSelector',
        params: { selector: resolveSelector(args[0]) },
      });
      return `Found ${args[0]}`;

    case 'hover':
      await sendCommand({ action: 'hover', params: { selector: resolveSelector(args[0]) } });
      return `Hovered ${args[0]}`;

    case 'clear':
      await sendCommand({ action: 'clearState' });
      return 'State cleared';

    case 'exit':
    case 'quit':
    case 'q':
      process.emit('SIGINT');
      return;

    default:
      throw new Error(`Unknown command: ${command}. Type "help" for available commands.`);
  }
}

function parseArgs(str: string): string[] {
  const args: string[] = [];
  const regex = /"([^"]+)"|'([^']+)'|(\S+)/g;
  let match;
  while ((match = regex.exec(str))) {
    args.push(match[1] || match[2] || match[3]);
  }
  return args;
}

function printHelp(): string {
  return `
Available Commands:
  goto <url>           Navigate to URL
  click <selector>     Click element
  type <sel> <text>    Type text into element
  text <selector>      Get text content
  html [selector]      Get HTML (page or element)
  screenshot [path]    Take screenshot
  url                  Get current URL
  title                Get page title
  eval <js>            Execute JavaScript
  wait [ms]            Wait milliseconds
  waitfor <selector>   Wait for element
  hover <selector>     Hover over element
  clear                Clear cookies/storage
  help                 Show this help
  exit                 Close browser and exit

Selectors:
  submit-btn           → [data-testid="submit-btn"]
  #id                  → #id
  .class               → .class
  [attr=val]           → [attr=val]

Examples:
  goto https://example.com
  click login-btn
  type email-input "user@test.com"
  text welcome-message
  screenshot ./debug.png
`.trim();
}
```

### CLI Integration

```typescript
// In src/cli.ts
case 'repl':
  runRepl({ headless: false });
  break;
```

## Usage

```bash
$ npx puppet repl

Starting Puppet REPL...
Browser ready. Type commands or "help" for usage.

puppet> goto https://example.com
Navigated to https://example.com

puppet> text h1
Example Domain

puppet> click more-info
Clicked more-info

puppet> screenshot ./shot.png
Screenshot saved: ./shot.png

puppet> exit
Closing browser...
```

## Acceptance Criteria

- [ ] REPL starts with visible browser
- [ ] All common commands available
- [ ] Smart selector resolution
- [ ] Helpful error messages
- [ ] Help command lists all commands
- [ ] Clean exit on Ctrl+C or exit command
- [ ] Command history (up arrow)
- [ ] CLI command `npx puppet repl`

## Testing

Manual testing - launch REPL and verify all commands work.

## Documentation Update

Add "REPL Mode" section to how-to-use-puppet.md.
