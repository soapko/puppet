# 002.feature.19: WebSocket Mode

**Status:** Pending
**Priority:** Low
**Complexity:** Medium

## Objective

Add WebSocket server mode for real-time, bidirectional browser control.

## Context

HTTP mode (002.feature.14) is great for simple request/response, but WebSocket offers:

- Real-time events from browser to client
- Lower latency for rapid commands
- Better for interactive/streaming use cases
- Native browser client support

## Technical Details

### New File: src/websocket.ts

```typescript
import { WebSocketServer, WebSocket } from 'ws';
import { startSession, sendCommand } from './session.js';
import type { SessionOptions, Command } from './types.js';

interface WSServerOptions extends SessionOptions {
  port?: number;
  host?: string;
}

export async function serveWebSocket(options: WSServerOptions = {}): Promise<WebSocketServer> {
  const { port = 3001, host = 'localhost', ...sessionOptions } = options;

  await startSession(sessionOptions);

  const wss = new WebSocketServer({ port, host });

  console.log(`Puppet WebSocket server running at ws://${host}:${port}`);

  wss.on('connection', (ws: WebSocket) => {
    console.log('Client connected');

    ws.send(JSON.stringify({ type: 'ready' }));

    ws.on('message', async (data: Buffer) => {
      try {
        const message = JSON.parse(data.toString());

        if (message.type === 'command') {
          const command: Command = message.command;
          const result = await sendCommand(command);

          ws.send(
            JSON.stringify({
              type: 'result',
              id: message.id,
              ...result,
            })
          );
        }
      } catch (error) {
        ws.send(
          JSON.stringify({
            type: 'error',
            error: error instanceof Error ? error.message : String(error),
          })
        );
      }
    });

    ws.on('close', () => {
      console.log('Client disconnected');
    });
  });

  return wss;
}
```

### Protocol

**Client → Server:**

```json
{
  "type": "command",
  "id": "unique-id",
  "command": {
    "action": "click",
    "params": { "selector": "#btn" }
  }
}
```

**Server → Client:**

```json
{
  "type": "ready"
}

{
  "type": "result",
  "id": "unique-id",
  "success": true,
  "result": {}
}

{
  "type": "error",
  "error": "Element not found"
}
```

### Future: Browser Events

Could emit events for:

- Page navigation
- Console messages
- Network requests
- Dialog popups

```json
{
  "type": "event",
  "event": "console",
  "data": { "type": "log", "text": "Hello" }
}
```

## Usage Examples

### From Node.js

```typescript
import WebSocket from 'ws';

const ws = new WebSocket('ws://localhost:3001');

ws.on('open', () => {
  ws.send(
    JSON.stringify({
      type: 'command',
      id: '1',
      command: { action: 'goto', params: { url: 'https://example.com' } },
    })
  );
});

ws.on('message', data => {
  const msg = JSON.parse(data.toString());
  console.log('Received:', msg);
});
```

### From Browser

```javascript
const ws = new WebSocket('ws://localhost:3001');

ws.onopen = () => {
  ws.send(
    JSON.stringify({
      type: 'command',
      id: '1',
      command: { action: 'goto', params: { url: 'https://example.com' } },
    })
  );
};

ws.onmessage = event => {
  const msg = JSON.parse(event.data);
  console.log('Result:', msg);
};
```

### CLI

```bash
npx puppet ws --port=3001
```

## Acceptance Criteria

- [ ] WebSocket server starts on specified port
- [ ] Sends ready message on connection
- [ ] Accepts command messages
- [ ] Returns result messages with matching id
- [ ] Error handling with error messages
- [ ] CLI command `npx puppet ws`
- [ ] Documentation with examples

## Dependencies

- `ws` package (already likely a dep of Playwright)

## Testing

```javascript
// test-ws.js
const WebSocket = require('ws');
const ws = new WebSocket('ws://localhost:3001');

ws.on('message', console.log);
ws.on('open', () => {
  ws.send(
    JSON.stringify({
      type: 'command',
      id: '1',
      command: { action: 'goto', params: { url: 'https://example.com' } },
    })
  );
});
```

## Documentation Update

Add "WebSocket Mode" section to how-to-use-puppet.md.
