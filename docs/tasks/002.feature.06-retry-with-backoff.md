# 002.feature.06: Retry with Backoff

**Status:** Pending
**Priority:** Medium
**Complexity:** Low

## Objective

Add opt-in retry logic with exponential backoff for commands that may fail transiently (element not yet rendered, network delays, etc.).

## Context

Flaky tests are often caused by timing issues - an element exists but wasn't rendered yet when the command ran. Rather than forcing users to add explicit waits everywhere, provide built-in retry capability that can be enabled per-command.

## Technical Details

### Implementation Location

New file: `src/retry.ts`
Updates to: `src/session.ts`

### Retry Utility

```typescript
// src/retry.ts

export interface RetryOptions {
  maxAttempts?: number; // Default: 3
  initialDelay?: number; // Default: 100ms
  maxDelay?: number; // Default: 2000ms
  backoffMultiplier?: number; // Default: 2
}

const DEFAULT_OPTIONS: Required<RetryOptions> = {
  maxAttempts: 3,
  initialDelay: 100,
  maxDelay: 2000,
  backoffMultiplier: 2,
};

/**
 * Retry a function with exponential backoff
 */
export async function withRetry<T>(fn: () => Promise<T>, options: RetryOptions = {}): Promise<T> {
  const opts = { ...DEFAULT_OPTIONS, ...options };
  let lastError: Error = new Error('No attempts made');
  let delay = opts.initialDelay;

  for (let attempt = 1; attempt <= opts.maxAttempts; attempt++) {
    try {
      return await fn();
    } catch (err) {
      lastError = err instanceof Error ? err : new Error(String(err));

      if (attempt === opts.maxAttempts) {
        break;
      }

      // Log retry attempt
      console.log(
        `[puppet:retry] Attempt ${attempt}/${opts.maxAttempts} failed, ` +
          `retrying in ${delay}ms: ${lastError.message}`
      );

      await new Promise(r => setTimeout(r, delay));
      delay = Math.min(delay * opts.backoffMultiplier, opts.maxDelay);
    }
  }

  throw lastError;
}

/**
 * Check if an error is retryable
 */
export function isRetryableError(err: Error): boolean {
  const msg = err.message.toLowerCase();
  return (
    msg.includes('element not found') ||
    msg.includes('not visible') ||
    msg.includes('timeout') ||
    msg.includes('waiting for selector') ||
    msg.includes('detached from document')
  );
}
```

### Command Parameter

Add optional `retry` parameter to commands:

```typescript
// Command with retry
{
  "action": "click",
  "params": {
    "selector": "[data-testid='submit']",
    "retry": 3  // Max attempts
  }
}

// Or with full options
{
  "action": "click",
  "params": {
    "selector": "[data-testid='submit']",
    "retry": {
      "maxAttempts": 5,
      "initialDelay": 200
    }
  }
}
```

### Integration in Session

```typescript
// src/session.ts
import { withRetry, isRetryableError } from './retry.js';

// Helper to wrap retryable commands
async function executeWithOptionalRetry<T>(
  fn: () => Promise<T>,
  retryParam: number | RetryOptions | undefined
): Promise<T> {
  if (!retryParam) {
    return fn();
  }

  const options: RetryOptions = typeof retryParam === 'number'
    ? { maxAttempts: retryParam }
    : retryParam;

  return withRetry(fn, options);
}

// In processCommand switch:
case 'click':
  await executeWithOptionalRetry(
    () => cursor.click(params.selector as string),
    params.retry as number | RetryOptions | undefined
  );
  break;

case 'type':
  await executeWithOptionalRetry(
    () => cursor.type(params.selector as string, params.text as string),
    params.retry as number | RetryOptions | undefined
  );
  break;

case 'waitFor':
  await executeWithOptionalRetry(
    () => page.waitForSelector(params.selector as string, {
      timeout: (params.timeout as number) ?? 5000,
    }),
    params.retry as number | RetryOptions | undefined
  );
  break;
```

## Acceptance Criteria

- [ ] `retry` parameter accepted on click, type, waitFor commands
- [ ] Simple number value sets maxAttempts
- [ ] Object value allows full retry configuration
- [ ] Exponential backoff between attempts
- [ ] Retry attempts logged for debugging
- [ ] Final error thrown after all attempts exhausted
- [ ] Commands without retry param work as before

## Testing

```javascript
// Test retry succeeds on second attempt
// (element appears after 150ms)
const result = await sendCommand({
  action: 'click',
  params: {
    selector: '[data-testid="delayed-button"]',
    retry: 3,
  },
});
// Should succeed after retry

// Test retry exhausted
const result2 = await sendCommand({
  action: 'click',
  params: {
    selector: '[data-testid="never-exists"]',
    retry: 2,
  },
});
// Should fail after 2 attempts with final error
```

## Documentation Update

Add to `how-to-use-puppet.md`:

### Retry Options

Commands that interact with elements (`click`, `type`, `waitFor`) support an optional `retry` parameter:

```javascript
// Retry up to 3 times with default backoff
await sendCommand({
  action: 'click',
  params: { selector: '.btn', retry: 3 },
});

// Custom retry configuration
await sendCommand({
  action: 'click',
  params: {
    selector: '.btn',
    retry: { maxAttempts: 5, initialDelay: 200, maxDelay: 3000 },
  },
});
```
