# 002.feature.04: Clear State Command

**Status:** Pending
**Priority:** High
**Complexity:** Low

## Objective

Add a `clearState` command that clears cookies, localStorage, and sessionStorage for test isolation.

## Context

Test isolation is critical for reliable automated testing. Tests should start from a clean slate without residual state from previous tests affecting outcomes. Currently, users must manually clear state via `evaluate` commands.

## Technical Details

### Implementation Location

`src/session.ts` - add new command case

### Command Definition

```typescript
case 'clearState':
  // Clear cookies
  await context.clearCookies();

  // Clear storage
  await page.evaluate(() => {
    localStorage.clear();
    sessionStorage.clear();
  });

  // Optionally clear IndexedDB
  if (params.includeIndexedDB) {
    await page.evaluate(async () => {
      const databases = await indexedDB.databases();
      for (const db of databases) {
        if (db.name) indexedDB.deleteDatabase(db.name);
      }
    });
  }

  result = { cleared: ['cookies', 'localStorage', 'sessionStorage'] };
  if (params.includeIndexedDB) {
    (result as { cleared: string[] }).cleared.push('indexedDB');
  }
  break;
```

### Parameters

| Param              | Type    | Default | Description                    |
| ------------------ | ------- | ------- | ------------------------------ |
| `includeIndexedDB` | boolean | false   | Also clear IndexedDB databases |

### Note on Context

The `clearCookies()` method requires access to the browser context, not just the page. The session already has access to context via `getBrowser()` return value, but we need to store it.

Update session initialization:

```typescript
let { browser, context, page } = await getBrowser({...});
```

## Acceptance Criteria

- [ ] `clearState` command clears cookies
- [ ] `clearState` command clears localStorage
- [ ] `clearState` command clears sessionStorage
- [ ] Optional `includeIndexedDB` param clears IndexedDB
- [ ] Result indicates what was cleared
- [ ] Works without navigating away from current page

## Testing

```javascript
// Set some state
await sendCommand({ action: 'goto', params: { url: 'https://example.com' } });
await sendCommand({
  action: 'evaluate',
  params: { script: 'localStorage.setItem("test", "value"); document.cookie = "foo=bar"' },
});

// Clear state
const result = await sendCommand({ action: 'clearState' });
console.log(result); // { cleared: ['cookies', 'localStorage', 'sessionStorage'] }

// Verify cleared
const check = await sendCommand({
  action: 'evaluate',
  params: { script: 'localStorage.getItem("test")' },
});
console.log(check.result); // null
```

## Documentation Update

Add to `how-to-use-puppet.md` Available Commands table:

| Action       | Params                       | Description                                 |
| ------------ | ---------------------------- | ------------------------------------------- |
| `clearState` | `includeIndexedDB` (boolean) | Clear cookies, localStorage, sessionStorage |
