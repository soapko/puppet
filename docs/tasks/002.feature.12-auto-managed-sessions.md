# 002.feature.12: Auto-Managed Sessions

**Status:** Pending
**Priority:** High
**Complexity:** Low

## Objective

Add a `withBrowser` pattern that automatically manages browser lifecycle, preventing resource leaks.

## Context

Current pattern requires manual cleanup:

```typescript
const session = await startSession();
try {
  await sendCommand({ action: 'goto', params: { url: '...' } });
  // ... do stuff
} finally {
  await sendCommand({ action: 'close' }); // Easy to forget!
}
```

If an error occurs and close isn't called, browser processes leak.

## Technical Details

### Implementation

```typescript
// src/fluent.ts (add to existing file)

export async function withBrowser<T>(
  fn: (browser: Browser) => Promise<T>,
  options: SessionOptions = {}
): Promise<T> {
  const browser = await puppet(options);
  try {
    return await fn(browser);
  } finally {
    await browser.close().catch(() => {
      // Ignore close errors - browser may already be closed
    });
  }
}
```

### Usage

```typescript
import { withBrowser } from 'puppet';

// Simple usage
await withBrowser(async browser => {
  await browser.goto('https://example.com');
  await browser.click('submit');
}); // Auto-closes, even if error thrown

// With options
await withBrowser(
  async browser => {
    await browser.goto('https://example.com');
    const title = await browser.evaluate('document.title');
    return title; // Can return values
  },
  { headless: true }
);

// Error handling
try {
  await withBrowser(async browser => {
    await browser.goto('https://bad-url.invalid');
  });
} catch (error) {
  console.log('Error occurred, but browser is still cleaned up');
}
```

### Integration with Fluent API

The `Browser` class from 002.feature.11 should support this pattern natively:

```typescript
// Alternative: static method on Browser class
class Browser {
  static async run<T>(fn: (browser: Browser) => Promise<T>, options?: SessionOptions): Promise<T> {
    return withBrowser(fn, options);
  }
}

// Usage
await Browser.run(async browser => {
  await browser.goto('https://example.com');
});
```

## Acceptance Criteria

- [ ] `withBrowser` function exported from package
- [ ] Browser closes on successful completion
- [ ] Browser closes on error
- [ ] Return values propagate correctly
- [ ] Options passed through to browser
- [ ] Close errors are silently ignored (browser may already be closed)
- [ ] Works with existing session system

## Testing

```typescript
import { withBrowser } from 'puppet';

// Test 1: Normal completion
await withBrowser(async browser => {
  await browser.goto('https://example.com');
  console.log('Done');
});
// Browser should be closed

// Test 2: Error handling
let errorThrown = false;
try {
  await withBrowser(async browser => {
    await browser.goto('https://example.com');
    throw new Error('Intentional error');
  });
} catch (e) {
  errorThrown = true;
}
console.log('Error thrown:', errorThrown); // true
// Browser should still be closed

// Test 3: Return value
const result = await withBrowser(async browser => {
  await browser.goto('https://example.com');
  return await browser.text('h1');
});
console.log('Result:', result);
```

## Documentation Update

Add to how-to-use-puppet.md:

```markdown
### Auto-Managed Sessions

Use `withBrowser` to ensure the browser always closes, even if errors occur:

import { withBrowser } from 'puppet';

await withBrowser(async (browser) => {
await browser.goto('https://example.com');
await browser.click('submit');
await browser.waitForLoaded();
}); // Browser automatically closes

// Return values work too
const pageTitle = await withBrowser(async (browser) => {
await browser.goto('https://example.com');
return await browser.evaluate('document.title');
});
```
