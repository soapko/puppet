# 002.feature.14: HTTP Server Mode

**Status:** Completed
**Priority:** Medium
**Complexity:** Medium

## Objective

Add an HTTP server mode that accepts commands via REST API, enabling language-agnostic browser automation.

## Context

Current interactive mode uses file-based IPC, which is:

- Complex to set up
- Slow (file system polling)
- Error-prone

HTTP server mode enables:

- Any language to control the browser via simple HTTP calls
- Easy debugging with curl
- Potential for a web-based control UI

## Technical Details

### New File: src/server.ts

```typescript
import http from 'http';
import { startSession, sendCommand } from './session.js';
import type { SessionOptions, Command } from './types.js';

interface ServerOptions extends SessionOptions {
  port?: number;
  host?: string;
}

export async function serve(options: ServerOptions = {}): Promise<http.Server> {
  const { port = 3000, host = 'localhost', ...sessionOptions } = options;

  // Start browser session
  await startSession(sessionOptions);

  const server = http.createServer(async (req, res) => {
    // CORS headers
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') {
      res.writeHead(204);
      res.end();
      return;
    }

    try {
      const result = await handleRequest(req);
      res.writeHead(200, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify(result));
    } catch (error) {
      res.writeHead(500, { 'Content-Type': 'application/json' });
      res.end(
        JSON.stringify({
          success: false,
          error: error instanceof Error ? error.message : String(error),
        })
      );
    }
  });

  return new Promise(resolve => {
    server.listen(port, host, () => {
      console.log(`Puppet server running at http://${host}:${port}`);
      resolve(server);
    });
  });
}

async function handleRequest(req: http.IncomingMessage) {
  const url = new URL(req.url || '/', `http://${req.headers.host}`);
  const path = url.pathname;

  // POST /command - Execute any command
  if (req.method === 'POST' && path === '/command') {
    const body = await readBody(req);
    const command: Command = JSON.parse(body);
    return await sendCommand(command);
  }

  // GET shortcuts for common commands
  if (req.method === 'GET') {
    const params = Object.fromEntries(url.searchParams);

    switch (path) {
      case '/goto':
        return sendCommand({ action: 'goto', params: { url: params.url } });

      case '/click':
        return sendCommand({
          action: 'click',
          params: { selector: params.selector || params.testid },
        });

      case '/type':
        return sendCommand({
          action: 'type',
          params: { selector: params.selector, text: params.text },
        });

      case '/text':
        return sendCommand({ action: 'getText', params: { selector: params.selector } });

      case '/screenshot':
        return sendCommand({ action: 'screenshot', params: { path: params.path } });

      case '/url':
        return sendCommand({ action: 'evaluate', params: { script: 'window.location.href' } });

      case '/close':
        return sendCommand({ action: 'close' });

      case '/health':
        return { status: 'ok' };

      default:
        throw new Error(`Unknown endpoint: ${path}`);
    }
  }

  throw new Error(`Method not allowed: ${req.method} ${path}`);
}

function readBody(req: http.IncomingMessage): Promise<string> {
  return new Promise((resolve, reject) => {
    let body = '';
    req.on('data', chunk => (body += chunk));
    req.on('end', () => resolve(body));
    req.on('error', reject);
  });
}
```

### CLI Entry Point

```typescript
// src/cli.ts
import { serve } from './server.js';

const args = process.argv.slice(2);
const port = parseInt(args.find(a => a.startsWith('--port='))?.split('=')[1] || '3000');
const headless = args.includes('--headless');

serve({ port, headless }).catch(console.error);
```

### Package.json bin

```json
{
  "bin": {
    "puppet": "./dist/cli.js",
    "puppet-serve": "./dist/cli.js"
  }
}
```

### API Endpoints

| Endpoint                      | Method | Description                     |
| ----------------------------- | ------ | ------------------------------- |
| `/command`                    | POST   | Execute any command (JSON body) |
| `/goto?url=...`               | GET    | Navigate to URL                 |
| `/click?selector=...`         | GET    | Click element                   |
| `/type?selector=...&text=...` | GET    | Type text                       |
| `/text?selector=...`          | GET    | Get text content                |
| `/screenshot?path=...`        | GET    | Take screenshot                 |
| `/url`                        | GET    | Get current URL                 |
| `/close`                      | GET    | Close browser                   |
| `/health`                     | GET    | Health check                    |

## Usage Examples

### Start Server

```bash
# Start with defaults (port 3000, headless)
npx puppet serve

# Custom port, visible browser
npx puppet serve --port=8080 --no-headless
```

### Use with curl

```bash
# Navigate
curl "http://localhost:3000/goto?url=https://example.com"

# Click a button
curl "http://localhost:3000/click?selector=[data-testid='submit']"

# Type text
curl "http://localhost:3000/type?selector=%23email&text=test@example.com"

# Get text
curl "http://localhost:3000/text?selector=h1"

# Screenshot
curl "http://localhost:3000/screenshot?path=./shot.png"

# Any command via POST
curl -X POST http://localhost:3000/command \
  -H "Content-Type: application/json" \
  -d '{"action":"click","params":{"selector":"#btn"}}'
```

### Use from Python

```python
import requests

BASE = "http://localhost:3000"

requests.get(f"{BASE}/goto", params={"url": "https://example.com"})
requests.get(f"{BASE}/click", params={"selector": "[data-testid='login']"})
requests.get(f"{BASE}/type", params={"selector": "#email", "text": "user@test.com"})

# Or use the command endpoint
requests.post(f"{BASE}/command", json={
    "action": "screenshot",
    "params": {"path": "screenshot.png"}
})
```

## Acceptance Criteria

- [ ] `serve()` function starts HTTP server
- [ ] POST /command accepts any command
- [ ] GET shortcuts for common commands
- [ ] CORS headers for browser access
- [ ] CLI command `npx puppet serve`
- [ ] Health check endpoint
- [ ] Proper error responses
- [ ] Documentation with examples

## Testing

```bash
# Start server
npx puppet serve --port=3000

# In another terminal
curl http://localhost:3000/health
curl "http://localhost:3000/goto?url=https://example.com"
curl "http://localhost:3000/text?selector=h1"
curl http://localhost:3000/close
```

## Documentation Update

Add "HTTP Server Mode" section to how-to-use-puppet.md.
