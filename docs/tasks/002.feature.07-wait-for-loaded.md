# 002.feature.07: Wait For Loaded Command

**Status:** Pending
**Priority:** Medium
**Complexity:** Low

## Objective

Add a `waitForLoaded` command that waits for common loading indicators to disappear and network to settle.

## Context

SPAs often show loading states (spinners, skeletons, progress bars) while fetching data. Tests need to wait for these to complete before interacting. Currently users must know the specific loading selectors. This command provides smart defaults.

## Technical Details

### Implementation Location

`src/session.ts` - add new command case

### Default Loading Selectors

Look for common patterns that indicate loading:

```typescript
const LOADING_SELECTORS = [
  // data-loading attribute (from testability standards)
  '[data-loading="true"]',

  // Common data-testid patterns
  '[data-testid*="loading"]',
  '[data-testid*="spinner"]',
  '[data-testid*="skeleton"]',

  // Common class patterns
  '.loading',
  '.spinner',
  '.skeleton',
  '.loading-indicator',
  '.loading-overlay',

  // ARIA
  '[aria-busy="true"]',

  // Common component patterns
  '.MuiSkeleton-root', // Material UI
  '.ant-skeleton', // Ant Design
  '.chakra-skeleton', // Chakra UI
  '[class*="shimmer"]', // Shimmer effects
];
```

### Command Implementation

```typescript
case 'waitForLoaded':
  const customSelectors = params.selectors as string[] | undefined;
  const selectorsToCheck = customSelectors ?? LOADING_SELECTORS;
  const timeout = (params.timeout as number) ?? 10000;
  const startTime = Date.now();

  // Wait for each loading selector to disappear
  for (const selector of selectorsToCheck) {
    if (Date.now() - startTime > timeout) {
      throw new Error(`Timeout waiting for page to finish loading`);
    }

    try {
      // Check if element exists
      const exists = await page.$(selector);
      if (exists) {
        // Wait for it to disappear
        await page.waitForSelector(selector, {
          state: 'hidden',
          timeout: Math.max(1000, timeout - (Date.now() - startTime)),
        });
      }
    } catch {
      // Selector doesn't exist or already hidden, continue
    }
  }

  // Also wait for network to be idle
  if (params.waitForNetwork !== false) {
    try {
      await page.waitForLoadState('networkidle', {
        timeout: Math.max(1000, timeout - (Date.now() - startTime)),
      });
    } catch {
      // Network didn't settle, but loading indicators are gone
      log.debug('Network did not reach idle state');
    }
  }

  result = { loaded: true };
  break;
```

### Parameters

| Param            | Type     | Default     | Description                          |
| ---------------- | -------- | ----------- | ------------------------------------ |
| `selectors`      | string[] | (see above) | Custom loading selectors to wait for |
| `timeout`        | number   | 10000       | Max wait time in ms                  |
| `waitForNetwork` | boolean  | true        | Also wait for network idle           |

## Acceptance Criteria

- [ ] Command waits for default loading selectors to disappear
- [ ] Custom selectors can be provided
- [ ] Respects timeout parameter
- [ ] Waits for network idle by default
- [ ] Network wait can be disabled
- [ ] Works even if no loading indicators present
- [ ] Doesn't fail if a selector pattern doesn't exist on page

## Testing

```javascript
// Navigate to page with loading state
await sendCommand({ action: 'goto', params: { url: 'https://app.com/dashboard' } });

// Wait for loading to complete
await sendCommand({ action: 'waitForLoaded' });

// Now safe to interact
await sendCommand({ action: 'click', params: { selector: '[data-testid="data-table"]' } });

// With custom selectors
await sendCommand({
  action: 'waitForLoaded',
  params: {
    selectors: ['[data-testid="custom-loader"]'],
    timeout: 5000,
  },
});

// Skip network wait for faster execution
await sendCommand({
  action: 'waitForLoaded',
  params: { waitForNetwork: false },
});
```

## Documentation Update

Add to `how-to-use-puppet.md` Available Commands table:

| Action          | Params                                      | Description                              |
| --------------- | ------------------------------------------- | ---------------------------------------- |
| `waitForLoaded` | `selectors?`, `timeout?`, `waitForNetwork?` | Wait for loading indicators to disappear |

### Usage Note

For best results, use `data-loading="true/false"` attributes in your app (per Web App Testability Standards). This command checks for `[data-loading="true"]` first.
