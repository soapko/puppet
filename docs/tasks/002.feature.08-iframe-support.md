# 002.feature.08: iframe Support

**Status:** Pending
**Priority:** Medium
**Complexity:** Medium

## Objective

Add commands to switch context into and out of iframes, enabling interaction with embedded content like payment forms, OAuth widgets, and third-party embeds.

## Context

Many web applications embed third-party content in iframes:

- Payment forms (Stripe, Braintree)
- OAuth/SSO login widgets
- CAPTCHA challenges
- Rich text editors
- Video embeds

Currently, puppet operates only on the main frame. This task adds iframe context switching.

## Technical Details

### Implementation Location

`src/session.ts` - add new commands and frame state tracking

### State Management

Track the current frame context:

```typescript
// Add to session state
let currentFrame: Frame | Page = page;

// Helper to get current frame for operations
function getCurrentFrame(): Frame | Page {
  return currentFrame;
}
```

### Commands

#### `switchToFrame`

Switch context into an iframe:

```typescript
case 'switchToFrame':
  const frameSelector = params.selector as string;

  // Find the iframe element
  const frameElement = await page.$(frameSelector);
  if (!frameElement) {
    throw new Error(`iframe not found: ${frameSelector}`);
  }

  // Get the frame content
  const frame = await frameElement.contentFrame();
  if (!frame) {
    throw new Error(`Could not access iframe content: ${frameSelector}. May be cross-origin restricted.`);
  }

  currentFrame = frame;
  result = { switched: true, url: frame.url() };
  break;
```

#### `switchToMain`

Switch back to main page context:

```typescript
case 'switchToMain':
  currentFrame = page;
  result = { switched: true };
  break;
```

#### `getFrames`

List available frames (for debugging):

```typescript
case 'getFrames':
  const frames = page.frames().map(f => ({
    name: f.name(),
    url: f.url(),
  }));
  result = frames;
  break;
```

### Update Existing Commands

Commands that interact with the page need to use `currentFrame`:

```typescript
case 'click':
  // Use currentFrame instead of page
  const clickTarget = currentFrame === page
    ? await cursor.click(params.selector as string)
    : await currentFrame.click(params.selector as string);
  break;

case 'type':
  if (currentFrame === page) {
    await cursor.type(params.selector as string, params.text as string);
  } else {
    await currentFrame.fill(params.selector as string, params.text as string);
  }
  break;

case 'waitFor':
  await currentFrame.waitForSelector(params.selector as string, {
    timeout: (params.timeout as number) ?? 5000,
  });
  break;

case 'evaluate':
  result = await currentFrame.evaluate(params.script as string);
  break;
```

### Note on Cursor in iframes

The ghost-cursor library operates on the main page. When in an iframe context, we fall back to direct Playwright methods without human-like cursor movement. This is acceptable since iframes are typically for form input, not navigation.

## Acceptance Criteria

- [ ] `switchToFrame` command switches context into specified iframe
- [ ] `switchToMain` command returns to main page context
- [ ] `getFrames` command lists all frames
- [ ] click/type/waitFor/evaluate work within iframe context
- [ ] Clear error if iframe not found
- [ ] Clear error if iframe is cross-origin restricted
- [ ] State resets to main frame on page navigation

## Testing

```javascript
// Navigate to page with Stripe payment form
await sendCommand({ action: 'goto', params: { url: 'https://checkout.example.com' } });

// List available frames
const frames = await sendCommand({ action: 'getFrames' });
console.log(frames.result);
// [{ name: '', url: '...' }, { name: 'stripe-frame', url: 'https://js.stripe.com/...' }]

// Switch to Stripe iframe
await sendCommand({
  action: 'switchToFrame',
  params: { selector: 'iframe[name="stripe-frame"]' },
});

// Interact with iframe content
await sendCommand({
  action: 'type',
  params: { selector: '[data-testid="card-number"]', text: '4242424242424242' },
});

// Switch back to main page
await sendCommand({ action: 'switchToMain' });

// Continue with main page
await sendCommand({
  action: 'click',
  params: { selector: '[data-testid="submit-payment"]' },
});
```

## Documentation Update

Add to `how-to-use-puppet.md` Available Commands table:

| Action          | Params     | Description                      |
| --------------- | ---------- | -------------------------------- |
| `switchToFrame` | `selector` | Switch context into an iframe    |
| `switchToMain`  | -          | Switch back to main page context |
| `getFrames`     | -          | List all frames on the page      |

### iframe Usage Note

When operating inside an iframe, cursor movements are not simulated (direct clicks used). This is typically fine since iframes are usually used for form input.
