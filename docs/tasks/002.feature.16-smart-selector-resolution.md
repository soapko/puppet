# 002.feature.16: Smart Selector Resolution

**Status:** Implemented
**Priority:** Medium
**Complexity:** Low

## Objective

Implement intelligent selector resolution that auto-detects selector type, reducing verbosity while maintaining flexibility.

## Context

This is an extension of 002.feature.10 (testid shorthand). While that feature adds explicit `testid` param support, this feature makes the `selector` param itself smarter.

Currently:

```typescript
await browser.click('[data-testid="submit"]'); // verbose
await browser.click('#submit'); // CSS ID
await browser.click('.btn-primary'); // CSS class
```

With smart resolution:

```typescript
await browser.click('submit'); // → [data-testid="submit"]
await browser.click('#submit'); // → #submit (unchanged)
await browser.click('.btn-primary'); // → .btn-primary (unchanged)
await browser.click('[name=email]'); // → [name=email] (unchanged)
```

## Technical Details

### Resolution Rules

```typescript
function resolveSelector(selector: string): string {
  // Already a CSS selector - use as-is
  if (selector.match(/^[.#\[>+~:]/)) {
    return selector;
  }

  // Contains spaces or combinators - use as-is (complex selector)
  if (selector.includes(' ') || selector.includes('>') || selector.includes('+')) {
    return selector;
  }

  // Tag name patterns - use as-is
  if (selector.match(/^(div|span|button|input|a|form|ul|li|table|img|h[1-6])$/i)) {
    return selector;
  }

  // Bare alphanumeric string (with hyphens/underscores) - treat as testid
  if (selector.match(/^[a-zA-Z][a-zA-Z0-9_-]*$/)) {
    return `[data-testid="${selector}"]`;
  }

  // Fallback - use as-is
  return selector;
}
```

### Selector Type Detection

| Input          | Type          | Resolved                     |
| -------------- | ------------- | ---------------------------- |
| `submit-btn`   | testid        | `[data-testid="submit-btn"]` |
| `loginForm`    | testid        | `[data-testid="loginForm"]`  |
| `user_input`   | testid        | `[data-testid="user_input"]` |
| `#submit`      | CSS ID        | `#submit`                    |
| `.btn`         | CSS class     | `.btn`                       |
| `[name=email]` | attribute     | `[name=email]`               |
| `button`       | tag           | `button`                     |
| `div.class`    | complex       | `div.class`                  |
| `.btn.primary` | chained class | `.btn.primary`               |
| `form input`   | descendant    | `form input`                 |
| `ul > li`      | child         | `ul > li`                    |
| `:first-child` | pseudo        | `:first-child`               |

### Implementation Location

Add to `src/selectors.ts`:

```typescript
/**
 * Resolve a selector string, treating bare alphanumeric strings as testids
 */
export function resolveSelector(selector: string): string {
  // Starts with CSS selector chars - use as-is
  if (/^[.#\[>+~:]/.test(selector)) {
    return selector;
  }

  // Contains combinators or spaces - use as-is
  if (/[\s>+~]/.test(selector)) {
    return selector;
  }

  // Common HTML tags - use as-is
  const htmlTags =
    /^(div|span|p|a|button|input|form|table|tr|td|th|ul|ol|li|img|h[1-6]|nav|header|footer|main|section|article|aside|label|select|option|textarea)$/i;
  if (htmlTags.test(selector)) {
    return selector;
  }

  // Bare identifier - treat as testid
  if (/^[a-zA-Z][a-zA-Z0-9_-]*$/.test(selector)) {
    return `[data-testid="${selector}"]`;
  }

  // Fallback
  return selector;
}

/**
 * Helper to explicitly create testid selector
 */
export function testid(id: string): string {
  return `[data-testid="${id}"]`;
}
```

### Integration Points

1. **Session processCommand**: Apply resolution to all selector params
2. **Fluent API Browser class**: Apply in each method
3. **Cursor class**: Apply before element lookup

```typescript
// In session.ts processCommand
if (params.selector) {
  params.selector = resolveSelector(params.selector as string);
}
```

## Escape Hatch

If you need a bare string to NOT be treated as testid:

```typescript
// These will not be auto-resolved
await browser.click('[data-testid="submit"]'); // explicit
await browser.click('button'); // recognized tag
```

## Acceptance Criteria

- [ ] `resolveSelector()` function implemented
- [ ] Bare alphanumeric strings → testid
- [ ] CSS selectors preserved
- [ ] HTML tag names preserved
- [ ] Complex selectors preserved
- [ ] Applied in session.ts
- [ ] Applied in fluent API
- [ ] Applied in cursor
- [ ] Exported from package
- [ ] Documentation updated

## Testing

```typescript
import { resolveSelector } from 'puppet';

// Testid resolution
resolveSelector('submit'); // '[data-testid="submit"]'
resolveSelector('login-btn'); // '[data-testid="login-btn"]'
resolveSelector('userInput'); // '[data-testid="userInput"]'

// Preserved as-is
resolveSelector('#submit'); // '#submit'
resolveSelector('.btn'); // '.btn'
resolveSelector('[name=x]'); // '[name=x]'
resolveSelector('button'); // 'button'
resolveSelector('div.foo'); // 'div.foo'
resolveSelector('ul > li'); // 'ul > li'
resolveSelector(':hover'); // ':hover'
```

## Documentation Update

Add to how-to-use-puppet.md:

```markdown
### Smart Selectors

Puppet automatically resolves bare strings as `data-testid` selectors:

// These are equivalent:
await browser.click('submit');
await browser.click('[data-testid="submit"]');

// CSS selectors work normally:
await browser.click('#id');
await browser.click('.class');
await browser.click('[attr=value]');
await browser.click('button');
await browser.click('form input');
```
