# 002.feature.11: Fluent API Wrapper

**Status:** Pending
**Priority:** High
**Complexity:** Medium

## Objective

Create a fluent, method-based API that wraps the command-based system for easier use.

## Context

Current API is verbose:

```typescript
import { startSession, sendCommand } from 'puppet';

const session = await startSession({ headless: false });
await sendCommand({ action: 'goto', params: { url: 'https://example.com' } });
await sendCommand({ action: 'click', params: { selector: '[data-testid="btn"]' } });
await sendCommand({ action: 'type', params: { selector: '#input', text: 'hello' } });
await sendCommand({ action: 'close' });
```

Fluent API is intuitive:

```typescript
import { puppet } from 'puppet';

const browser = await puppet({ headless: false });
await browser.goto('https://example.com');
await browser.click('btn'); // testid shorthand
await browser.type('#input', 'hello');
await browser.close();
```

## Technical Details

### New File: src/fluent.ts

```typescript
import { startSession, sendCommand } from './session.js';
import type { SessionOptions, CommandResult } from './types.js';

export class Browser {
  private ready: boolean = false;

  constructor(private options: SessionOptions = {}) {}

  async init(): Promise<this> {
    await startSession(this.options);
    this.ready = true;
    return this;
  }

  private resolveSelector(selector: string): string {
    if (selector.match(/^[.#\[]/)) return selector;
    return `[data-testid="${selector}"]`;
  }

  async goto(url: string): Promise<void> {
    await sendCommand({ action: 'goto', params: { url } });
  }

  async click(selector: string): Promise<void> {
    await sendCommand({
      action: 'click',
      params: { selector: this.resolveSelector(selector) },
    });
  }

  async type(selector: string, text: string): Promise<void> {
    await sendCommand({
      action: 'type',
      params: { selector: this.resolveSelector(selector), text },
    });
  }

  async text(selector: string): Promise<string> {
    const result = await sendCommand({
      action: 'getText',
      params: { selector: this.resolveSelector(selector) },
    });
    return result.result as string;
  }

  async screenshot(path?: string): Promise<string> {
    const result = await sendCommand({
      action: 'screenshot',
      params: path ? { path } : {},
    });
    return result.result as string;
  }

  async waitForLoaded(): Promise<void> {
    await sendCommand({ action: 'waitForLoaded' });
  }

  async close(): Promise<void> {
    await sendCommand({ action: 'close' });
  }

  // ... more methods
}

// Factory function
export async function puppet(options: SessionOptions = {}): Promise<Browser> {
  const browser = new Browser(options);
  return browser.init();
}
```

### Methods to Implement

| Method              | Maps To         | Signature                                                     |
| ------------------- | --------------- | ------------------------------------------------------------- |
| `goto(url)`         | goto            | `(url: string) => Promise<void>`                              |
| `click(sel)`        | click           | `(selector: string) => Promise<void>`                         |
| `type(sel, text)`   | type            | `(selector: string, text: string) => Promise<void>`           |
| `text(sel)`         | getText         | `(selector: string) => Promise<string>`                       |
| `value(sel)`        | getValue        | `(selector: string) => Promise<string>`                       |
| `html(sel?)`        | getHtml         | `(selector?: string) => Promise<string>`                      |
| `screenshot(path?)` | screenshot      | `(path?: string) => Promise<string>`                          |
| `select(sel, val)`  | select          | `(selector: string, value: string) => Promise<void>`          |
| `check(sel)`        | check           | `(selector: string) => Promise<void>`                         |
| `uncheck(sel)`      | uncheck         | `(selector: string) => Promise<void>`                         |
| `hover(sel)`        | hover           | `(selector: string) => Promise<void>`                         |
| `scroll(sel)`       | scroll          | `(selector: string) => Promise<void>`                         |
| `wait(ms)`          | wait            | `(ms: number) => Promise<void>`                               |
| `waitFor(sel)`      | waitForSelector | `(selector: string) => Promise<void>`                         |
| `waitForLoaded()`   | waitForLoaded   | `() => Promise<void>`                                         |
| `evaluate(fn)`      | evaluate        | `(fn: string) => Promise<any>`                                |
| `upload(sel, path)` | uploadFile      | `(selector: string, path: string\|string[]) => Promise<void>` |
| `frame(sel)`        | switchToFrame   | `(selector: string) => Promise<void>`                         |
| `mainFrame()`       | switchToMain    | `() => Promise<void>`                                         |
| `clearState()`      | clearState      | `() => Promise<void>`                                         |
| `close()`           | close           | `() => Promise<void>`                                         |

### Export from Index

```typescript
// src/index.ts
export { puppet, Browser } from './fluent.js';
```

## Acceptance Criteria

- [ ] `puppet()` function returns initialized Browser instance
- [ ] All common commands have method equivalents
- [ ] Smart selector resolution (bare string = testid)
- [ ] Methods return appropriate types (void, string, etc.)
- [ ] TypeScript types fully defined
- [ ] Existing command API still works (backward compatible)
- [ ] Documentation with examples

## Testing

```typescript
import { puppet } from 'puppet';

const browser = await puppet({ headless: false });

await browser.goto('https://example.com');
await browser.click('login-btn');
await browser.type('email-input', 'test@example.com');
await browser.type('#password', 'secret'); // CSS selector still works
await browser.click('submit');
await browser.waitForLoaded();

const welcomeText = await browser.text('welcome-message');
console.log(welcomeText);

await browser.screenshot('./login-success.png');
await browser.close();
```

## Documentation Update

Add new "Fluent API" section to how-to-use-puppet.md as the primary recommended approach.
