# 002.feature.20: Recording Mode

**Status:** Pending
**Priority:** Low
**Complexity:** Very High

## Objective

Add a recording mode that captures user interactions and generates test scripts automatically.

## Context

Writing tests from scratch is tedious. Recording mode lets users:

- Perform actions in the browser manually
- Automatically capture those actions as code
- Edit/refine the generated test

This is a major feature similar to Playwright Codegen.

## Technical Details

### Architecture

```
┌─────────────────────────────────────────────┐
│                  Browser                     │
│  ┌─────────────────────────────────────┐    │
│  │         Injected Recorder           │    │
│  │  - Event listeners (click, type)    │    │
│  │  - Selector generation              │    │
│  │  - Sends events via DevTools        │    │
│  └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────┐
│              Node.js Process                 │
│  ┌─────────────────────────────────────┐    │
│  │         Event Collector             │    │
│  │  - Receives browser events          │    │
│  │  - Deduplicates/optimizes           │    │
│  │  - Generates code                   │    │
│  └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘
                    │
                    ▼
              Generated Test File
```

### Injected Recorder Script

```typescript
// src/recorder/injected.ts
(function () {
  const events: RecordedEvent[] = [];

  function getSelector(el: Element): string {
    // Priority: data-testid > id > unique class > path
    if (el.hasAttribute('data-testid')) {
      return `[data-testid="${el.getAttribute('data-testid')}"]`;
    }
    if (el.id) {
      return `#${el.id}`;
    }
    // ... more strategies
    return generateCSSPath(el);
  }

  function recordEvent(type: string, target: Element, data?: object) {
    const event = {
      type,
      selector: getSelector(target),
      timestamp: Date.now(),
      ...data,
    };
    events.push(event);
    // Send to Node.js via CDP
    (window as any).__puppetRecorderCallback?.(event);
  }

  document.addEventListener(
    'click',
    e => {
      recordEvent('click', e.target as Element);
    },
    true
  );

  document.addEventListener(
    'input',
    e => {
      const target = e.target as HTMLInputElement;
      recordEvent('type', target, { value: target.value });
    },
    true
  );

  // ... more event handlers
})();
```

### Code Generator

```typescript
// src/recorder/generator.ts
interface RecordedEvent {
  type: string;
  selector: string;
  value?: string;
  timestamp: number;
}

export function generateTestCode(events: RecordedEvent[]): string {
  const lines: string[] = [
    "import { test } from 'puppet/test';",
    '',
    "test('recorded test', async ({ page }) => {",
  ];

  for (const event of events) {
    const selector = simplifySelector(event.selector);
    switch (event.type) {
      case 'goto':
        lines.push(`  await page.goto('${event.value}');`);
        break;
      case 'click':
        lines.push(`  await page.click('${selector}');`);
        break;
      case 'type':
        lines.push(`  await page.type('${selector}', '${event.value}');`);
        break;
      case 'select':
        lines.push(`  await page.select('${selector}', '${event.value}');`);
        break;
    }
  }

  lines.push('});');
  return lines.join('\n');
}

function simplifySelector(selector: string): string {
  // Convert [data-testid="x"] to just "x" for readability
  const match = selector.match(/\[data-testid="([^"]+)"\]/);
  if (match) return match[1];
  return selector;
}
```

### Recording CLI

```typescript
// src/recorder/cli.ts
import { chromium } from 'playwright';
import { generateTestCode } from './generator.js';

export async function record(options: RecordOptions): Promise<void> {
  const browser = await chromium.launch({ headless: false });
  const context = await browser.newContext();
  const page = await context.newPage();

  const events: RecordedEvent[] = [];

  // Inject recorder
  await page.addInitScript({ path: './injected.js' });

  // Set up callback
  await page.exposeFunction('__puppetRecorderCallback', (event: RecordedEvent) => {
    events.push(event);
    console.log(`Recorded: ${event.type} on ${event.selector}`);
  });

  // Navigate to start URL
  if (options.url) {
    await page.goto(options.url);
    events.push({ type: 'goto', selector: '', value: options.url, timestamp: Date.now() });
  }

  // Wait for user to close browser or press Ctrl+C
  console.log('\nRecording... Perform actions in the browser.');
  console.log('Press Ctrl+C or close the browser when done.\n');

  await new Promise<void>(resolve => {
    page.on('close', resolve);
    process.on('SIGINT', resolve);
  });

  // Generate code
  const code = generateTestCode(events);
  console.log('\n--- Generated Test ---\n');
  console.log(code);

  if (options.output) {
    await fs.writeFile(options.output, code);
    console.log(`\nSaved to ${options.output}`);
  }

  await browser.close();
}
```

## Usage

```bash
# Start recording
npx puppet record --url=https://example.com --output=tests/example.test.ts

# Opens browser, user performs actions, outputs:
Recording... Perform actions in the browser.
Press Ctrl+C or close the browser when done.

Recorded: click on submit-btn
Recorded: type on email-input
Recorded: click on login-btn

--- Generated Test ---

import { test } from 'puppet/test';

test('recorded test', async ({ page }) => {
  await page.goto('https://example.com');
  await page.click('submit-btn');
  await page.type('email-input', 'user@test.com');
  await page.click('login-btn');
});

Saved to tests/example.test.ts
```

## Challenges

1. **Selector Quality**: Generating stable selectors is hard
2. **Event Deduplication**: Rapid typing creates many events
3. **Timing**: When to record waits
4. **Iframes**: Recording across frames
5. **SPAs**: Handling navigation without page loads

## Acceptance Criteria

- [ ] CLI command `npx puppet record`
- [ ] Opens visible browser
- [ ] Records clicks
- [ ] Records typing (debounced)
- [ ] Records navigation
- [ ] Generates valid test code
- [ ] Prioritizes data-testid selectors
- [ ] Optional output file
- [ ] Handles page close gracefully
- [ ] Basic documentation

## Dependencies

- 002.feature.11 (Fluent API) - for generated code style
- 002.feature.18 (Test runner integration) - for test format

## Testing

Manual testing - record a simple flow and verify generated code runs.

## Future Enhancements

- Assertion recording (right-click menu)
- Visual selector picker
- Edit during recording
- Record to multiple formats (Playwright, Cypress, etc.)
